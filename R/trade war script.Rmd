---
title: "Trade War and Trump's approval rate"
author: "Haokun Zhang"
date: "5/8/2022"
output: pdf_document
---

```{r setup, include=FALSE}
#import modules
library(dplyr)
library(ggplot2)
library(rdrobust)
library(magrittr)
library(haven)
library(tidyverse)
library(data.table)
library(fixest)
library(glue)
library(data.table)
library(caret)
library(glmnet)
library(gbm)
library(ggmap)
library(rpart)
library(rpart.plot)
library(randomForest)
library(rsample)
library(modelr)
library(fastDummies)
library(scales)
library(here)
library(knitr)
library(kableExtra)
library(stargazer)
library(here)
library(foreach)
library(rddensity)

path <- here()
```

## R Markdown


```{r data_descripton, echo = FALSE}
#import data
trump_vote = read.csv("C:/Users/Haokun Zhang/Desktop/github/trade_war_effects/data/approval_topline.csv")

#filter the data to only voters
voter_data = trump_vote %>%
  filter(subgroup == "Voters")
voter_data = voter_data %>%
  select(subgroup, 
         modeldate, 
         approve_estimate, 
         approve_hi, 
         approve_lo, 
         disapprove_estimate, 
         disapprove_hi, 
         disapprove_lo) 

# create a dataframe of voter_data
df_voter_data <- data.frame(modeldate = c(voter_data$modeldate), 
                            approve_estimate = c(voter_data$approve_estimate))

# describing modeldate in date class
df_voter_data$modeldate <- as.Date(voter_data$modeldate, format = "%m/%d/%Y")

# plot of distribution across time
p <- ggplot(data = df_voter_data, aes(x=modeldate, y=approve_estimate)) + geom_line() + scale_x_date(date_labels = "%Y/%m/%d") + geom_vline(xintercept = as.Date("2018-04-02"), color = "red")

# show p
plot(p)
```

```{r local linear RD point estimator with h=20 and uniform kernel, echo=FALSE}
cutoff = as.numeric(as.Date("2018-04-02"))

out1 = rdrobust(df_voter_data$approve_estimate, df_voter_data$modeldate, kernel = "uniform", p =1, h = 20, c= cutoff)
summary(out1)

#statistically insignificant results
#arbitrary bandwidth

```

```{r local linear RD point estimator with h=20 and triangular kernel, echo=FALSE}
out2 = rdrobust(df_voter_data$approve_estimate, df_voter_data$modeldate, kernel = "triangular", p =1, h = 20, c= cutoff)
summary(out2)

#statistically insignificant results
#arbitrary bandwidth

```

```{r local quadratic RD with triangular kernel, h=20 and p=2, echo=FALSE}
out3 = rdrobust(df_voter_data$approve_estimate, df_voter_data$modeldate, kernel = "triangular", p =2, h = 20, c= cutoff)
summary(out3)

#arbitrary bandwidth

```

```{r "optimal bandwidth selection using MSE-optimal bandwidth", echo=FALSE}
bwd1 = rdbwselect(df_voter_data$approve_estimate, df_voter_data$modeldate, kernel = "triangular", p =1, bwselect = "mserd", c= cutoff)
summary(bwd1)
```

```{r "optimal bandwidth selection using two MSE-optimal", echo=FALSE}
bwd2 = rdbwselect(df_voter_data$approve_estimate, df_voter_data$modeldate, kernel = "triangular", p =1, bwselect = "msetwo" , c= cutoff)
summary(bwd2)
```


```{r "local linear RD with MSE bandwidth", echo=FALSE}
out4 = rdrobust(df_voter_data$approve_estimate, df_voter_data$modeldate, kernel = "triangular", p =1, bwselect = "mserd", c= cutoff)
summary(out4)
```

```{r local linear RD with triangular kernel and exlcuded regularization term}
out5 = rdrobust(df_voter_data$approve_estimate, df_voter_data$modeldate, kernel = "triangular", scaleregul = 0, p =1, bwselect = "mserd", c= cutoff, all = TRUE)
summary(out5)
```

```{r local linear RD with triangular kernel with all is TRUE}
out6 = rdrobust(df_voter_data$approve_estimate, df_voter_data$modeldate, kernel = "triangular", p =1, bwselect = "mserd", all=TRUE, c= cutoff)
summary(out6)
```

```{r "local linear RD with triangular kernel with CER-optimal bandwith choice", echo=FALSE}
out7 = rdrobust(df_voter_data$approve_estimate, df_voter_data$modeldate, kernel = "triangular", p =1, bwselect = "cerrd", c= cutoff)
summary(out7)

#statistically insignificant results
```

```{r "all bandwidth", echo=FALSE}
bdw3 = rdbwselect(df_voter_data$approve_estimate, df_voter_data$modeldate, kernel = "triangular", p =1, all = TRUE, c= cutoff)
summary(bdw3)

# shows all bandwidth calculations
```


```{r out8 with covariates, echo=FALSE}

 Z = cbind(trump_vote$approve_hi, trump_vote$approve_lo, trump_vote$disapprove_estimate,
trump_vote$disapprove_hi, trump_vote$disapprove_lo)

out8 = rdrobust(df_voter_data$approve_estimate, df_voter_data$modeldate, c= cutoff, covs = Z, kernel = "triangular", scaleregul = 1,p = 1, bwselect = "mserd")
summary(out8)

```



```{r rdplot, echo=FALSE}

## simple scatter plot with cutoff and bandwidths
ggplot(data = df_voter_data, aes(x=modeldate, y=approve_estimate)) + geom_point() + scale_x_date(date_labels = "%Y/%m/%d") + scale_x_date(limits = as.Date(c("2018-3-02", "2018-04-30"))) + geom_vline(xintercept = as.Date("2018-04-02"), color = "red")
 
## Implement rdplot 
y = (df_voter_data$approve_estimate)
x = as.numeric(df_voter_data$modeldate)
c = as.numeric(as.Date("2018-04-02"))

bandwidth = rdrobust(y, x, c=cutoff, kernel = "triangular", p = 1, bwselect = "mserd")$bws[1,1]
out = rdplot(y[abs(x) <= bandwidth], x[abs(x) <= bandwidth], p = 1, kernel = "triangular", cex.axis = 1.5, cex.lab = 1.5)

plot1 = rdplot(y,x, ci=95, hide=TRUE)
rdplot_mean_bin = plot1$vars_bins[,"rdplot_mean_bin"]
rdplot_mean_y   = plot1$vars_bins[,"rdplot_mean_y"]
y_hat           = plot1$vars_poly[,"rdplot_y"]
x_plot          = plot1$vars_poly[,"rdplot_x"]
rdplot_cil_bin =  plot1$vars_bins[,"rdplot_ci_l"]
rdplot_cir_bin =  plot1$vars_bins[,"rdplot_ci_r"]
rdplot_mean_bin=  plot1$vars_bins[,"rdplot_mean_bin"]
y_hat_r=y_hat[x_plot>=c]
y_hat_l=y_hat[x_plot<c]
x_plot_r=x_plot[x_plot>=c]
x_plot_l=x_plot[x_plot<c]

col.lines = "blue"
col.dots  = 1
type.dots = 20
title="RD Plot"
x.label="X axis"
y.label="Y axis"
x.lim=c(min(x, na.rm=T),max(x, na.rm=T))
y.lim=c(min(y, na.rm=T), max(y, na.rm=T))


temp_plot <- ggplot() + theme_bw() +
  geom_point( aes(x = rdplot_mean_bin, y = rdplot_mean_y), col = col.dots, na.rm = TRUE) +
  geom_line(  aes(x = x_plot_l, y = y_hat_l), col = col.lines, na.rm = TRUE) +
  geom_line(  aes(x = x_plot_r, y = y_hat_r), col = col.lines, na.rm = TRUE) +
  labs(x = x.label, y = y.label) + ggtitle(title) +
  labs(title = title, y = y.label, x = x.label) +
  coord_cartesian(xlim = x.lim, ylim = y.lim) +
  theme(legend.position = "None") +
  geom_vline(xintercept = c, size = 0.5)
temp_plot


```

```{r rddensity and rddensity plot, echo=FALSE}
rdd = rddensity(X = df_voter_data$modeldate, c= cutoff, bwselect = "each", p=1, all = TRUE, kernel = "triangular")

rdplot <- rdplotdensity(rdd, X = df_voter_data$modeldate)

```


